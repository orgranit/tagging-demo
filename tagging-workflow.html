<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagging Workflow Simulator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        
        .container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .left-column, .right-column {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .left-column {
            flex: 0 0 500px;
        }
        
        .right-column {
            flex: 1;
            min-width: 0;
        }
        
        h1 {
            margin-top: 0;
            color: #333;
            font-size: 24px;
        }
        
        h2 {
            color: #555;
            font-size: 18px;
            margin: 20px 0 10px 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        h3 {
            color: #666;
            font-size: 16px;
            margin: 15px 0 8px 0;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .attachments-table input {
            width: 100%;
            border: none;
            padding: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .attachments-table select {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 12px;
            min-width: 100px;
        }
        
        .attachments-table th:nth-child(3),
        .attachments-table td:nth-child(3) {
            min-width: 120px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .log-entry.pass {
            background-color: #d4edda;
            color: #155724;
        }
        
        .log-entry.fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .log-entry.vault-removed {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
        }
        
        .arrays-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .empty-state {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .step-panel {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .step-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }
        
        .step-content {
            padding: 15px;
        }
        
        .removed-vaults {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            color: #856404;
        }
        
        .add-row-btn {
            background-color: #17a2b8;
            color: white;
            font-size: 12px;
            padding: 4px 8px;
        }
        
        .req-link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .req-link:hover {
            color: #0056b3;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .modal-title {
            margin: 0;
            color: #333;
        }
        
        .close {
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .btn-approve {
            background-color: #28a745;
            color: white;
        }
        
        .btn-reject {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-column">
            <h1>Tagging Workflow</h1>
            
            <h2>Inputs</h2>
            
            <div class="input-group">
                <label for="vaults">Vaults (comma or newline separated):</label>
                <textarea id="vaults" rows="3" placeholder="v1, v2, v3">v1,v2</textarea>
            </div>
            
            <div class="input-group">
                <label for="tagsToAdd">Tags To Add:</label>
                <textarea id="tagsToAdd" rows="3" placeholder="t1, t2, t3">t1,t2</textarea>
            </div>
            
            <div class="input-group">
                <label for="tagsToRemove">Tags To Remove:</label>
                <textarea id="tagsToRemove" rows="3" placeholder="t3, t4">t3</textarea>
            </div>
            
            <h2>Attachments Table</h2>
            <div id="attachmentsTableContainer">
                <table class="attachments-table">
                    <thead>
                        <tr>
                            <th>Vault ID</th>
                            <th>Tag ID</th>
                            <th>Status</th>
                            <th>Req ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="attachmentsTableBody">
                    </tbody>
                </table>
                <button class="add-row-btn" onclick="addAttachmentRow()">+ Add Row</button>
            </div>
            
            <div class="button-group">
                <button class="btn-primary" onclick="generateCandidates()">Generate Candidates</button>
                <button class="btn-warning" onclick="runSanitization()">Run Sanitization</button>
                <button class="btn-success" onclick="applyToTable()">Apply to Table</button>
                <button class="btn-secondary" onclick="resetData()">Reset</button>
            </div>
        </div>
        
        <div class="right-column">
            <h1>Results & Progress</h1>
            
            <div class="step-panel">
                <div class="step-header">Step 1: Parsed Inputs</div>
                <div class="step-content">
                    <div id="parsedInputs" class="arrays-display">
                        <div class="empty-state">Click "Generate Candidates" to see parsed inputs</div>
                    </div>
                </div>
            </div>
            
            <div class="step-panel">
                <div class="step-header">Step 2: Candidates</div>
                <div class="step-content">
                    <div id="candidatesTable">
                        <div class="empty-state">No candidates generated yet</div>
                    </div>
                </div>
            </div>
            
            <div class="step-panel">
                <div class="step-header">Step 3: Sanitization Log</div>
                <div class="step-content">
                    <div id="sanitizationLog" class="log-container">
                        <div class="empty-state">Run sanitization to see processing log</div>
                    </div>
                </div>
            </div>
            
            <div class="step-panel">
                <div class="step-header">Step 4: Results</div>
                <div class="step-content">
                    <h3>Valid Pairs</h3>
                    <div id="validPairsTable">
                        <div class="empty-state">No valid pairs yet</div>
                    </div>
                    
                    <h3>Removed Vaults</h3>
                    <div id="removedVaults">
                        <div class="empty-state">No vaults removed yet</div>
                    </div>
                </div>
            </div>
            
            <div class="step-panel">
                <div class="step-header">Step 5: Updated Attachments</div>
                <div class="step-content">
                    <div id="updatedAttachmentsTable">
                        <div class="empty-state">Apply changes to see updated table</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Request Details</h3>
                <button class="close" onclick="closeRequestModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Request details will be populated here -->
            </div>
            <div class="modal-buttons">
                <button class="btn-approve" onclick="approveRequest()">Approve</button>
                <button class="btn-reject" onclick="rejectRequest()">Reject</button>
                <button class="btn-secondary" onclick="closeRequestModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentAttachments = [];
        let currentCandidates = [];
        let currentValidPairs = [];
        let currentRemovedVaults = [];
        let currentSanitizationLog = [];
        let currentModalReqId = null;
        let requestMetadata = {}; // Store request metadata by reqId

        // Initialize with starter data
        function initializeStarterData() {
            currentAttachments = [
                { vaultId: 'v1', tagId: 't9', status: 'final', reqId: null },
                { vaultId: 'v1', tagId: 't3', status: 'final', reqId: null },
                { vaultId: 'v2', tagId: 't8', status: 'pending add', reqId: 'REQ-001' },
                { vaultId: 'v2', tagId: 't5', status: 'final', reqId: null }
            ];
            
            // Add sample metadata for existing request
            requestMetadata['REQ-001'] = {
                vaults: ['v2'],
                tagsToAdd: ['t8'],
                tagsToRemove: [],
                timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString() // Yesterday
            };
            
            renderAttachmentsTable();
            clearResults();
        }

        // Parse comma or newline separated list
        function parseList(str) {
            if (!str || typeof str !== 'string') return [];
            return str.split(/[,\n]/)
                      .map(item => item.trim())
                      .filter(item => item.length > 0)
                      .filter((item, index, array) => array.indexOf(item) === index); // dedupe
        }

        // Build candidates with conflict resolution
        function buildCandidates(vaults, addTags, removeTags) {
            const candidates = [];
            const conflicts = new Set(); // track (vault,tag) pairs that have conflicts
            
            // First pass: identify conflicts
            for (const vault of vaults) {
                for (const tag of addTags) {
                    if (removeTags.includes(tag)) {
                        conflicts.add(`${vault}:${tag}`);
                    }
                }
            }
            
            // Second pass: generate candidates, preferring remove for conflicts
            for (const vault of vaults) {
                // Add candidates
                for (const tag of addTags) {
                    const key = `${vault}:${tag}`;
                    if (!conflicts.has(key)) {
                        candidates.push({ vaultId: vault, tagId: tag, action: 'add' });
                    }
                }
                
                // Remove candidates (always included, even for conflicts)
                for (const tag of removeTags) {
                    candidates.push({ vaultId: vault, tagId: tag, action: 'remove' });
                }
            }
            
            return candidates;
        }

        // Sanitize candidates with sequential validation
        function sanitizeCandidates(candidates, attachments) {
            const removedVaults = new Set();
            const validPairs = [];
            const validPairCount = new Map();
            const log = [];
            
            for (let i = 0; i < candidates.length; i++) {
                const candidate = candidates[i];
                const { vaultId, tagId, action } = candidate;
                
                let isValid = true;
                let reason = '';
                
                // Rule 1: Check if vault was removed earlier
                if (removedVaults.has(vaultId)) {
                    isValid = false;
                    reason = 'vault removed earlier';
                } else if (action === 'add') {
                    // Rule 2a: Check if attachment already exists
                    const existingAttachment = attachments.find(att => 
                        att.vaultId === vaultId && att.tagId === tagId
                    );
                    if (existingAttachment) {
                        isValid = false;
                        reason = 'already exists';
                    } else {
                        // Rule 2b: Check capacity limit (count existing + pending + current batch)
                        const existingCount = attachments.filter(att => 
                            att.vaultId === vaultId && att.status !== 'pending remove'
                        ).length;
                        const currentBatchCount = validPairCount.get(vaultId) || 0;
                        const totalCount = existingCount + currentBatchCount;
                        
                        if (totalCount >= 3) {
                            isValid = false;
                            reason = 'capacity reached (max 3)';
                        }
                    }
                } else if (action === 'remove') {
                    // Rule 3: Can only remove existing attachments
                    const existingAttachment = attachments.find(att => 
                        att.vaultId === vaultId && att.tagId === tagId
                    );
                    if (!existingAttachment) {
                        isValid = false;
                        reason = 'attachment does not exist';
                    }
                }
                
                if (isValid) {
                    // Accept the candidate
                    validPairs.push(candidate);
                    validPairCount.set(vaultId, (validPairCount.get(vaultId) || 0) + 1);
                    log.push({
                        step: i + 1,
                        candidate: candidate,
                        status: 'PASS',
                        reason: 'accepted'
                    });
                } else {
                    // Rule 4: On first invalid for a vault, remove vault and purge its pairs
                    log.push({
                        step: i + 1,
                        candidate: candidate,
                        status: 'FAIL',
                        reason: reason
                    });
                    
                    if (!removedVaults.has(vaultId)) {
                        // First failure for this vault
                        removedVaults.add(vaultId);
                        
                        // Purge previously accepted pairs for this vault
                        const originalLength = validPairs.length;
                        for (let j = validPairs.length - 1; j >= 0; j--) {
                            if (validPairs[j].vaultId === vaultId) {
                                validPairs.splice(j, 1);
                            }
                        }
                        
                        // Reset count
                        validPairCount.set(vaultId, 0);
                        
                        log.push({
                            step: i + 1,
                            candidate: candidate,
                            status: 'VAULT_REMOVED',
                            reason: `Vault ${vaultId} removed due to: ${reason}`,
                            vaultRemoved: true
                        });
                    }
                }
            }
            
            return {
                validPairs: validPairs,
                removedVaults: Array.from(removedVaults),
                log: log
            };
        }

        // Apply valid pairs to attachments table
        function applyValidPairs(validPairs, attachments) {
            let newAttachments = [...attachments];
            
            // Generate unique request ID for this batch
            const reqId = `REQ-${String(Date.now()).slice(-6)}`;
            
            // Extract the applied vaults and tags from validPairs
            const appliedVaults = [...new Set(validPairs.map(p => p.vaultId))];
            const appliedAddTags = [...new Set(validPairs.filter(p => p.action === 'add').map(p => p.tagId))];
            const appliedRemoveTags = [...new Set(validPairs.filter(p => p.action === 'remove').map(p => p.tagId))];
            
            // Store metadata for this request
            requestMetadata[reqId] = {
                vaults: appliedVaults,
                tagsToAdd: appliedAddTags,
                tagsToRemove: appliedRemoveTags,
                timestamp: new Date().toISOString()
            };
            
            for (const pair of validPairs) {
                const { vaultId, tagId, action } = pair;
                
                if (action === 'add') {
                    // Add new pending row only if not already present
                    const exists = newAttachments.find(att => 
                        att.vaultId === vaultId && att.tagId === tagId
                    );
                    
                    if (!exists) {
                        newAttachments.push({ vaultId, tagId, status: 'pending add', reqId });
                    }
                } else if (action === 'remove') {
                    // Update existing row status to pending remove
                    const existingRow = newAttachments.find(att => 
                        att.vaultId === vaultId && att.tagId === tagId
                    );
                    
                    if (existingRow) {
                        existingRow.status = 'pending remove';
                        existingRow.reqId = reqId;
                    }
                }
            }
            
            return newAttachments;
        }

        // Render functions
        function renderParsedInputs(vaults, addTags, removeTags) {
            const container = document.getElementById('parsedInputs');
            container.innerHTML = `
                <div><strong>Vaults:</strong> [${vaults.map(v => `"${v}"`).join(', ')}]</div>
                <div><strong>Tags To Add:</strong> [${addTags.map(t => `"${t}"`).join(', ')}]</div>
                <div><strong>Tags To Remove:</strong> [${removeTags.map(t => `"${t}"`).join(', ')}]</div>
            `;
        }

        function renderCandidatesTable(candidates) {
            const container = document.getElementById('candidatesTable');
            if (candidates.length === 0) {
                container.innerHTML = '<div class="empty-state">No candidates generated</div>';
                return;
            }
            
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Vault ID</th>
                            <th>Tag ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${candidates.map(c => `
                            <tr>
                                <td>${c.vaultId}</td>
                                <td>${c.tagId}</td>
                                <td>${c.action}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function renderSanitizationLog(log) {
            const container = document.getElementById('sanitizationLog');
            if (log.length === 0) {
                container.innerHTML = '<div class="empty-state">Run sanitization to see processing log</div>';
                return;
            }
            
            const logEntries = log.map(entry => {
                if (entry.vaultRemoved) {
                    return `<div class="log-entry vault-removed">Step ${entry.step}: ${entry.reason}</div>`;
                } else {
                    const cssClass = entry.status === 'PASS' ? 'pass' : 'fail';
                    const candidateStr = `{${entry.candidate.vaultId}, ${entry.candidate.tagId}, ${entry.candidate.action}}`;
                    return `<div class="log-entry ${cssClass}">Step ${entry.step}: ${candidateStr} → ${entry.status} (${entry.reason})</div>`;
                }
            }).join('');
            
            container.innerHTML = logEntries;
        }

        function renderValidPairs(validPairs) {
            const container = document.getElementById('validPairsTable');
            if (validPairs.length === 0) {
                container.innerHTML = '<div class="empty-state">No valid pairs</div>';
                return;
            }
            
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Vault ID</th>
                            <th>Tag ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${validPairs.map(p => `
                            <tr>
                                <td>${p.vaultId}</td>
                                <td>${p.tagId}</td>
                                <td>${p.action}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function renderRemovedVaults(removedVaults) {
            const container = document.getElementById('removedVaults');
            if (removedVaults.length === 0) {
                container.innerHTML = '<div class="empty-state">No vaults removed</div>';
                return;
            }
            
            container.innerHTML = `<div class="removed-vaults">Removed vaults: ${removedVaults.join(', ')}</div>`;
        }

        function renderAttachmentsTable() {
            const tbody = document.getElementById('attachmentsTableBody');
            tbody.innerHTML = currentAttachments.map((att, index) => {
                const reqIdCell = att.reqId ? 
                    `<span class="req-link" onclick="showRequestModal('${att.reqId}')">${att.reqId}</span>` : 
                    '<span style="color: #6c757d;">-</span>';
                
                return `
                <tr>
                    <td><input type="text" value="${att.vaultId}" onchange="updateAttachment(${index}, 'vaultId', this.value)"></td>
                    <td><input type="text" value="${att.tagId}" onchange="updateAttachment(${index}, 'tagId', this.value)"></td>
                    <td>
                        <select onchange="updateAttachment(${index}, 'status', this.value)">
                            <option value="final" ${att.status === 'final' ? 'selected' : ''}>final</option>
                            <option value="pending add" ${att.status === 'pending add' ? 'selected' : ''}>pending add</option>
                            <option value="pending remove" ${att.status === 'pending remove' ? 'selected' : ''}>pending remove</option>
                        </select>
                    </td>
                    <td>${reqIdCell}</td>
                    <td><button class="btn-secondary" style="font-size: 11px; padding: 2px 6px;" onclick="removeAttachment(${index})">Remove</button></td>
                </tr>
            `;
            }).join('');
        }

        function renderUpdatedAttachments(attachments) {
            const container = document.getElementById('updatedAttachmentsTable');
            if (attachments.length === 0) {
                container.innerHTML = '<div class="empty-state">No attachments</div>';
                return;
            }
            
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Vault ID</th>
                            <th>Tag ID</th>
                            <th>Status</th>
                            <th>Req ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${attachments.map(att => {
                            const reqIdCell = att.reqId ? 
                                `<span class="req-link" onclick="showRequestModal('${att.reqId}')">${att.reqId}</span>` : 
                                '<span style="color: #6c757d;">-</span>';
                            return `
                            <tr>
                                <td>${att.vaultId}</td>
                                <td>${att.tagId}</td>
                                <td>${att.status}</td>
                                <td>${reqIdCell}</td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        // Event handlers
        function generateCandidates() {
            const vaultsStr = document.getElementById('vaults').value;
            const addTagsStr = document.getElementById('tagsToAdd').value;
            const removeTagsStr = document.getElementById('tagsToRemove').value;
            
            const vaults = parseList(vaultsStr);
            const addTags = parseList(addTagsStr);
            const removeTags = parseList(removeTagsStr);
            
            console.log('Parsed inputs:', { vaults, addTags, removeTags });
            
            currentCandidates = buildCandidates(vaults, addTags, removeTags);
            
            console.log('Generated candidates:', currentCandidates);
            
            renderParsedInputs(vaults, addTags, removeTags);
            renderCandidatesTable(currentCandidates);
            
            // Clear later steps
            currentValidPairs = [];
            currentRemovedVaults = [];
            currentSanitizationLog = [];
            renderSanitizationLog([]);
            renderValidPairs([]);
            renderRemovedVaults([]);
        }

        function runSanitization() {
            if (currentCandidates.length === 0) {
                alert('Generate candidates first');
                return;
            }
            
            console.log('Starting sanitization with:', { 
                candidates: currentCandidates, 
                attachments: currentAttachments 
            });
            
            const result = sanitizeCandidates(currentCandidates, currentAttachments);
            currentValidPairs = result.validPairs;
            currentRemovedVaults = result.removedVaults;
            currentSanitizationLog = result.log;
            
            console.log('Sanitization result:', result);
            
            renderSanitizationLog(currentSanitizationLog);
            renderValidPairs(currentValidPairs);
            renderRemovedVaults(currentRemovedVaults);
        }

        function applyToTable() {
            if (currentValidPairs.length === 0) {
                alert('Run sanitization first to get valid pairs');
                return;
            }
            
            // Update the main attachments table
            currentAttachments = applyValidPairs(currentValidPairs, currentAttachments);
            
            // Re-render both the editable table and the results view
            renderAttachmentsTable();
            renderUpdatedAttachments(currentAttachments);
        }

        function resetData() {
            // Reset inputs
            document.getElementById('vaults').value = 'v1,v2';
            document.getElementById('tagsToAdd').value = 't1,t2';
            document.getElementById('tagsToRemove').value = 't3';
            
            // Reset state
            initializeStarterData();
        }

        function clearResults() {
            currentCandidates = [];
            currentValidPairs = [];
            currentRemovedVaults = [];
            currentSanitizationLog = [];
            
            document.getElementById('parsedInputs').innerHTML = '<div class="empty-state">Click "Generate Candidates" to see parsed inputs</div>';
            document.getElementById('candidatesTable').innerHTML = '<div class="empty-state">No candidates generated yet</div>';
            document.getElementById('sanitizationLog').innerHTML = '<div class="empty-state">Run sanitization to see processing log</div>';
            document.getElementById('validPairsTable').innerHTML = '<div class="empty-state">No valid pairs yet</div>';
            document.getElementById('removedVaults').innerHTML = '<div class="empty-state">No vaults removed yet</div>';
            document.getElementById('updatedAttachmentsTable').innerHTML = '<div class="empty-state">Apply changes to see updated table</div>';
        }

        function updateAttachment(index, field, value) {
            if (index >= 0 && index < currentAttachments.length) {
                currentAttachments[index][field] = value;
            }
        }

        function removeAttachment(index) {
            currentAttachments.splice(index, 1);
            renderAttachmentsTable();
        }

        function addAttachmentRow() {
            currentAttachments.push({ vaultId: '', tagId: '', status: 'final', reqId: null });
            renderAttachmentsTable();
        }

        // Modal functions
        function showRequestModal(reqId) {
            currentModalReqId = reqId;
            const requestPairs = currentAttachments.filter(att => att.reqId === reqId);
            const metadata = requestMetadata[reqId];
            
            document.getElementById('modalTitle').textContent = `Request ${reqId}`;
            
            const modalBody = document.getElementById('modalBody');
            if (requestPairs.length === 0) {
                modalBody.innerHTML = '<div class="empty-state">No pairs found for this request</div>';
            } else {
                let inputsSection = '';
                if (metadata) {
                    inputsSection = `
                        <div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 6px; border-left: 4px solid #007bff;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">Original Inputs (Applied)</h4>
                            <div style="font-family: monospace; font-size: 13px; line-height: 1.4;">
                                <div><strong>Vaults:</strong> [${metadata.vaults.map(v => `"${v}"`).join(', ')}]</div>
                                ${metadata.tagsToAdd.length > 0 ? `<div><strong>Tags To Add:</strong> [${metadata.tagsToAdd.map(t => `"${t}"`).join(', ')}]</div>` : ''}
                                ${metadata.tagsToRemove.length > 0 ? `<div><strong>Tags To Remove:</strong> [${metadata.tagsToRemove.map(t => `"${t}"`).join(', ')}]</div>` : ''}
                            </div>
                            <div style="margin-top: 8px; font-size: 11px; color: #6c757d;">
                                Created: ${new Date(metadata.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `;
                }
                
                const table = `
                    <h4 style="margin: 0 0 10px 0; color: #333;">Affected Pairs</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Vault ID</th>
                                <th>Tag ID</th>
                                <th>Action</th>
                                <th>Current Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requestPairs.map(pair => `
                                <tr>
                                    <td>${pair.vaultId}</td>
                                    <td>${pair.tagId}</td>
                                    <td>${pair.status.replace('pending ', '')}</td>
                                    <td><span style="color: ${pair.status === 'pending add' ? '#28a745' : '#dc3545'};">${pair.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                modalBody.innerHTML = inputsSection + table;
            }
            
            document.getElementById('requestModal').style.display = 'block';
        }

        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
            currentModalReqId = null;
        }

        function approveRequest() {
            if (!currentModalReqId) return;
            
            // Process each attachment with this reqId
            currentAttachments = currentAttachments.filter(att => {
                if (att.reqId === currentModalReqId) {
                    if (att.status === 'pending remove') {
                        // Remove the attachment completely
                        return false;
                    }
                    // For pending add, convert to final
                    att.status = 'final';
                    att.reqId = null;
                }
                return true;
            });
            
            renderAttachmentsTable();
            renderUpdatedAttachments(currentAttachments);
            closeRequestModal();
        }

        function rejectRequest() {
            if (!currentModalReqId) return;
            
            // Remove all rows with this reqId 
            currentAttachments = currentAttachments.filter(att => att.reqId !== currentModalReqId);
            
            renderAttachmentsTable();
            renderUpdatedAttachments(currentAttachments);
            closeRequestModal();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('requestModal');
            if (event.target === modal) {
                closeRequestModal();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeStarterData();
        });
    </script>
</body>
</html>