<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault Account Tagging API - Product Requirements Document</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #172b4d;
            background: #f4f5f7;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 500;
            text-align: center;
            margin: 0 0 24px 0;
            color: #172b4d;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 32px 0 16px 0;
            color: #172b4d;
            border-bottom: 2px solid #dfe1e6;
            padding-bottom: 8px;
        }
        
        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 24px 0 12px 0;
            color: #172b4d;
        }
        
        h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 20px 0 8px 0;
            color: #172b4d;
        }
        
        h5 {
            font-size: 1rem;
            font-weight: 600;
            margin: 16px 0 8px 0;
            color: #172b4d;
        }
        
        p {
            margin: 12px 0;
            font-size: 14px;
            color: #42526e;
        }
        
        ul, ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        li {
            margin: 4px 0;
            font-size: 14px;
            color: #42526e;
        }
        
        .section {
            margin: 25px 0;
            page-break-inside: avoid;
        }
        
        .subsection {
            margin: 20px 0 15px 20px;
        }
        
        .code-block {
            font-family: 'Courier New', monospace;
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            font-size: 10pt;
            line-height: 1.4;
            white-space: pre-wrap;
            page-break-inside: avoid;
        }
        
        .nav-section {
            text-align: center;
            margin: 24px 0;
            background: #ffffff;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 16px;
            box-shadow: 0 1px 1px rgba(9, 30, 66, 0.25);
        }
        
        .nav-section a {
            display: inline-block;
            margin: 0 12px;
            padding: 8px 16px;
            text-decoration: none;
            color: #0052cc;
            font-weight: 500;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .nav-section a:hover {
            background: #deebff;
            border-color: #0052cc;
        }
        
        .toc {
            background: #ffffff;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 20px;
            margin: 24px 0;
            box-shadow: 0 1px 1px rgba(9, 30, 66, 0.25);
        }
        
        .toc h3 {
            color: #172b4d;
            margin-top: 0;
            margin-bottom: 16px;
            text-align: center;
            font-size: 1.125rem;
        }
        
        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .toc-item {
            background: #fafbfc;
            padding: 12px;
            border-radius: 3px;
            border: 1px solid #dfe1e6;
            transition: all 0.2s ease;
        }
        
        .toc-item:hover {
            background: #f4f5f7;
            border-color: #b3d4ff;
        }
        
        .toc-item a {
            text-decoration: none;
            color: #172b4d;
            font-weight: 500;
            display: block;
        }
        
        .toc-item.active {
            background: #deebff;
            border-color: #0052cc;
        }
        
        .toc-item.active a {
            color: #0052cc;
            font-weight: 600;
        }
        
        .document-header {
            text-align: center;
            margin-bottom: 32px;
            background: #ffffff;
            border: 1px solid #dfe1e6;
            border-radius: 3px;
            padding: 24px;
            box-shadow: 0 1px 1px rgba(9, 30, 66, 0.25);
        }
        
        .document-subtitle {
            font-size: 1rem;
            color: #42526e;
            margin: 8px 0;
        }
        
        .document-meta {
            font-size: 0.875rem;
            color: #6b778c;
            margin-top: 16px;
        }
        
        .operation-section {
            margin: 32px 0;
            padding: 20px;
            background: #ffffff;
            border-radius: 3px;
            border: 1px solid #dfe1e6;
            box-shadow: 0 1px 1px rgba(9, 30, 66, 0.25);
        }
        
        .rule-list {
            background: #fafbfc;
            border: 1px solid #dfe1e6;
            padding: 16px;
            margin: 16px 0;
            border-radius: 3px;
        }
        
        .example-block {
            border: 1px solid #dfe1e6;
            background: #f4f5f7;
            padding: 16px;
            margin: 16px 0;
            border-radius: 3px;
        }
        
        .example-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-decoration: underline;
        }
        
        @media print {
            body { margin: 0; padding: 20px; }
            .nav-section, .toc { display: none; }
            h2 { page-break-before: always; }
            .operation-section { 
                background: none !important; 
                border: none !important; 
                box-shadow: none !important;
            }
        }
        
        /* Smooth scroll for anchor links */
        html {
            scroll-behavior: smooth;
        }
        
        .back-to-top {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #0052cc;
            color: white;
            border: none;
            border-radius: 3px;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 1px 1px rgba(9, 30, 66, 0.25);
            z-index: 1000;
        }
        
        .back-to-top.visible {
            opacity: 1;
        }
        
        .back-to-top:hover {
            background: #0065ff;
            box-shadow: 0 4px 8px rgba(9, 30, 66, 0.25);
        }
        
        /* Section anchors with offset for better navigation */
        .operation-section {
            scroll-margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="document-header">
        <h1>Vault Account Tagging API</h1>
        <div class="document-subtitle">Product Requirements Document</div>
        <div class="document-subtitle">Business Rules by Operation</div>
        <div class="document-meta">
            <strong>Version:</strong> 1.0 | <strong>Status:</strong> Production Ready | <strong>Date:</strong> January 2025
        </div>
    </div>

    <div class="nav-section">
        <a href="./tagging-workflow-v2.html">ðŸ“Š Interactive Simulator</a>
        <a href="./tagging-api-docs-standalone.html">ðŸ“š API Documentation</a>
    </div>

    <div class="toc">
        <h3>ðŸ“‘ Document Contents</h3>
        <div class="toc-grid">
            <div class="toc-item create">
                <a href="#create-operations">CREATE Operations</a>
            </div>
            <div class="toc-item update">
                <a href="#update-operations">UPDATE Operations</a>
            </div>
            <div class="toc-item delete">
                <a href="#delete-operations">DELETE Operations</a>
            </div>
            <div class="toc-item attach">
                <a href="#attach-detach-operations">ATTACH/DETACH Operations</a>
            </div>
            <div class="toc-item state">
                <a href="#tag-state-management">Tag State Management</a>
            </div>
        </div>
    </div>

    <div class="operation-section create" id="create-operations">
        <h2>CREATE Tag Operations</h2>

        <div class="section">
            <h3>Business Rules</h3>
            <div class="rule-list">
                <ul>
                    <li><strong>Name Uniqueness:</strong> Tag names must be unique across the entire system</li>
                    <li><strong>Name Requirements:</strong> Tag names cannot be empty or whitespace-only</li>
                    <li><strong>Description Optional:</strong> Tag descriptions are optional but recommended</li>
                    <li><strong>Protection Status:</strong> Tags can be created as protected or non-protected</li>
                    <li><strong>System Validation:</strong> All fields validated for proper data types and constraints</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h3>Validation Cases</h3>
            <ul>
                <li><strong>Empty Name:</strong> Cannot create tag with empty or null name</li>
                <li><strong>Duplicate Name:</strong> Cannot create tag with existing name</li>
                <li><strong>Invalid Characters:</strong> Tag names must follow naming conventions</li>
                <li><strong>Field Length Limits:</strong> Name and description have maximum length constraints</li>
            </ul>
        </div>
    </div>

    <div class="operation-section update" id="update-operations">
        <h2>UPDATE Tag Operations</h2>
        <div class="code-block">PATCH /taggingService/tag/{id}</div>

        <div class="section">
            <h3>Business Rules</h3>
            <div class="rule-list">
                <ul>
                    <li><strong>Pending Operations Block:</strong> Cannot edit ANY field if tag has pending attach/detach operations</li>
                    <li><strong>Name Uniqueness:</strong> New name must be unique across system (excluding current tag)</li>
                    <li><strong>Partial Updates:</strong> Only provided fields are updated (PATCH semantics)</li>
                    <li><strong>Concurrent Safety:</strong> Edit operations are locked during processing</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h3>Validation Cases</h3>
            <ul>
                <li><strong>Tag Not Found (404):</strong> Tag ID does not exist</li>
                <li><strong>Tag Has Pending Operations (400):</strong> Cannot edit tag with pending attach/detach operations</li>
                <li><strong>Name Conflict (400):</strong> New tag name already exists for another tag</li>
                <li><strong>Invalid Fields (400):</strong> Empty name, invalid boolean values, field length violations</li>
            </ul>
            
            <div class="example-block">
                <div class="example-title">Error Response Example</div>
                <div class="code-block">{
  "error": "tag_has_pending_operations",
  "message": "Cannot edit tag with pending operations",
  "details": {
    "pendingOperations": 3
  }
}</div>
            </div>
        </div>

        <div class="section">
            <h3>Edge Cases</h3>
            <p><strong>Concurrent Name Changes:</strong> When two protected tags are simultaneously being changed to the same name:</p>
            <ul>
                <li>First approval wins the name</li>
                <li>Second approval fails due to database constraint violation</li>
            </ul>
        </div>
    </div>

    <div class="operation-section delete" id="delete-operations">
        <h2>DELETE Tag Operations</h2>
        <div class="code-block">DELETE /taggingService/tag/{id}</div>

        <div class="section">
            <h3>Business Rules</h3>
            <div class="rule-list">
                <ul>
                    <li><strong>Active Attachments Block:</strong> Cannot delete tags with active vault attachments</li>
                    <li><strong>Pending Operations Block:</strong> Cannot delete tags with pending attach/detach operations</li>
                    <li><strong>Cascade Prevention:</strong> System prevents deletion of in-use tags</li>
                    <li><strong>Concurrent Safety:</strong> Delete operations are locked during processing</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h3>Validation Cases</h3>
            <ul>
                <li><strong>Tag Not Found (404):</strong> Tag ID does not exist</li>
                <li><strong>Tag In Use (400):</strong> Tag has active attachments to vault accounts</li>
                <li><strong>Pending Operations (400):</strong> Tag has pending attach/detach operations</li>
            </ul>

            <div class="example-block">
                <div class="example-title">Error Response Example</div>
                <div class="code-block">{
  "error": "tag_in_use",
  "message": "Cannot delete tag with active attachments or pending operations",
  "details": {
    "activeAttachments": 5,
    "pendingOperations": 2
  }
}</div>
            </div>
        </div>
    </div>

    <div class="operation-section attach" id="attach-detach-operations">
        <h2>ATTACH/DETACH Operations</h2>
        <div class="code-block">POST /vault/accounts/tags

Request Schema:
{
  "vaultAccountIds": string[],     // 1-10 numeric vault account IDs
  "tagIdsToAttach": string[],      // 0-20 tags to attach
  "tagIdsToDetach": string[]       // 0-20 tags to detach
}

Response Schema:
{
  "status": "all_applied" | "all_pending" | "mixed_results" | "all_rejected",
  "message": string,
  "appliedOperations": Operation[],
  "pendingOperations": Operation[],
  "rejectedOperations": Operation[]
}</div>

    <div class="scenario attach">
        <h4>Business Rules</h4>
        <ul>
            <li><strong>Capacity Limit:</strong> Maximum 20 tag attachments per vault account</li>
            <li><strong>Entire Vault Rejection:</strong> If capacity exceeded, ALL operations for that vault are rejected (both attach AND detach)</li>
            <li><strong>Protected Tag Workflow:</strong> Protected tags require approval, non-protected are immediate</li>
            <li><strong>Request ID Consistency:</strong> All protected operations in single API call share same request ID</li>
            <li><strong>Priority-Based Validation:</strong> Only first validation error returned</li>
            <li><strong>Batch Processing:</strong> Multiple vaults and tags processed in single request</li>
        </ul>
    </div>

    <div class="scenario validation">
        <h4>Validation Rules (Priority Order)</h4>
        <ol>
            <li><strong>Array Size Limits:</strong> Maximum 20 tags in attach/detach arrays</li>
            <li><strong>Conflicting Operations:</strong> Same tag cannot appear in both attach and detach arrays</li>
            <li><strong>Vault Account Existence:</strong> All vault account IDs must exist in system</li>
            <li><strong>Tag Existence:</strong> All referenced tags must exist in system</li>
            <li><strong>Tag Availability:</strong> Tags must not be under modification (pending edit/delete)</li>
        </ol>

        <p><strong>Validation Error Example:</strong></p>
        <div class="code">{
  "error": "validation_failed",
  "details": [{
    "field": "tagIdsToAttach",
    "error": "array_too_large",
    "message": "Maximum 20 tags allowed, got 21"
  }]
}</div>
    </div>

    <div class="scenario rejection">
        <h4>Business Rule Rejections</h4>
        <ul>
            <li><strong>capacity_exceeded:</strong> Vault would exceed 20-tag limit</li>
            <li><strong>attachment_already_exists:</strong> Tag already attached to vault</li>
            <li><strong>attachment_does_not_exist:</strong> Tag not currently attached to vault</li>
            <li><strong>pending_request_exists:</strong> Conflicting pending approval request exists</li>
        </ul>

        <p><strong>Business Rule Rejection Example:</strong></p>
        <div class="code">{
  "status": "all_rejected",
  "message": "4 rejected",
  "appliedOperations": [],
  "pendingOperations": [],
  "rejectedOperations": [
    {
      "vaultAccountId": "1",
      "tagId": "tag1", 
      "action": "attach",
      "reason": "capacity_exceeded"
    }
  ]
}</div>
    </div>

    <div class="scenario success">
        <h4>Success Scenarios</h4>
        <ol>
            <li><strong>all_applied:</strong> All operations completed immediately (non-protected tags only)</li>
            <li><strong>all_pending:</strong> All operations require approval (protected tags only)</li>
            <li><strong>mixed_results:</strong> Operations distributed across applied/pending/rejected</li>
            <li><strong>all_rejected:</strong> All operations failed business rule checks</li>
        </ol>
    </div>

    <div class="scenario attach">
        <h4>Sanitization Scenarios</h4>
        
        <h5>1. Pre-Calculation Capacity Check</h5>
        <ul>
            <li>System calculates vault capacity impact before processing any operations</li>
            <li>If vault would exceed 20-tag limit, marks entire vault for rejection</li>
            <li>All operations (attach AND detach) for that vault are rejected with <code>capacity_exceeded</code></li>
        </ul>

        <h5>2. Operation State Filtering</h5>
        <ul>
            <li><strong>Attach Operations:</strong> System checks if tag is already attached to vault</li>
            <li><strong>Detach Operations:</strong> System checks if tag is currently attached to vault</li>
            <li>Invalid operations are rejected with appropriate reason codes before processing</li>
        </ul>

        <h5>3. Protected vs Non-Protected Separation</h5>
        <ul>
            <li>Operations are separated by tag protection status after validation</li>
            <li>Non-protected operations processed immediately â†’ <code>appliedOperations</code></li>
            <li>Protected operations require approval â†’ <code>pendingOperations</code> with request ID</li>
        </ul>

        <h5>4. Conflicting Pending Request Detection</h5>
        <ul>
            <li>System checks for existing pending approval requests for same vault/tag combination</li>
            <li>New operations are rejected if conflicting pending request exists</li>
            <li>Prevents multiple simultaneous approval workflows for same resource</li>
        </ul>
    </div>

    <div class="scenario success">
        <h4>Protected vs Non-Protected Flow</h4>
        
        <h5>Non-Protected Tags:</h5>
        <ul>
            <li>Immediate processing â†’ <code>appliedOperations</code> array</li>
            <li>Status: <code>final</code></li>
        </ul>

        <h5>Protected Tags:</h5>
        <ul>
            <li>Require approval â†’ <code>pendingOperations</code> array</li>
            <li>Status: <code>pending</code></li>
            <li>Include <code>requestId</code> (shared across all protected operations in same API call)</li>
        </ul>
    </div>

    <div class="operation-section state" id="tag-state-management">
        <h2>Tag State Management</h2>

    <div class="scenario">
        <h4>Tag States</h4>
        <ul>
            <li><strong>Available:</strong> Tag can be used in attach/detach operations</li>
            <li><strong>Being Modified:</strong> Tag is being edited - blocks new operations</li>
            <li><strong>Being Deleted:</strong> Tag is being deleted - blocks all operations</li>
            <li><strong>In Use:</strong> Tag has active attachments - blocks deletion</li>
        </ul>
    </div>

    <div class="scenario">
        <h4>Operation Interactions</h4>
        <ul>
            <li><strong>CREATE:</strong> No restrictions, creates new available tag</li>
            <li><strong>UPDATE:</strong> Blocked by pending attach/detach operations</li>
            <li><strong>DELETE:</strong> Blocked by active attachments OR pending operations</li>
            <li><strong>ATTACH/DETACH:</strong> Blocked by tags being modified or deleted</li>
        </ul>
    </div>

    <div class="scenario">
        <h4>Concurrent Safety</h4>
        <ul>
            <li>Database-level locking prevents race conditions</li>
            <li>First operation wins in conflict scenarios</li>
            <li>Subsequent operations informed of conflicts via specific error codes</li>
        </ul>
    </div>

        <div class="section" style="text-align: center; margin-top: 40px; font-style: italic;">
            Complete business rules and validation coverage for all tag operations
        </div>
    </div>

    <button class="back-to-top" onclick="scrollToTop()" title="Back to top">â†‘</button>

    <script>
        // Back to top functionality
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show/hide back to top button
        window.addEventListener('scroll', function() {
            const backToTop = document.querySelector('.back-to-top');
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        });

        // Highlight current section in TOC (optional enhancement)
        window.addEventListener('scroll', function() {
            const sections = document.querySelectorAll('.operation-section');
            const tocItems = document.querySelectorAll('.toc-item');
            
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop - 50;
                if (window.scrollY >= sectionTop) {
                    current = section.getAttribute('id');
                }
            });
            
            tocItems.forEach(item => {
                item.classList.remove('active');
                const link = item.querySelector('a');
                if (link && link.getAttribute('href') === '#' + current) {
                    item.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>